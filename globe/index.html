<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>WebGL Globe</title>
	<meta charset="utf-8">
	<style type="text/css">
		html { height: 100%; }
		body {
			margin: 0;
			padding: 0;
			background: black url(/globe/loading.gif) no-repeat center center;
			color: white;
			font-family: sans-serif;
			font-size: 13px;
			line-height: 20px;
			height: 100%;
		}

		#flickr {
			position: absolute;
			top: 10px;
			left: 10px;
			background: transparent url('http://l.yimg.com/g/images/flickr-sprite.png.v3') no-repeat -1083px -9px;
			width: 75px;
			height: 22px;
		}
		
		#yahoo {
			position: absolute;
			top: 23px;
			left: 85px;
			width: 69px;
			height: 9px;
			background: url('http://l.yimg.com/g/images/lightbox/en-us/from-yahoo-white.png') no-repeat 0 0;
		}
	</style>
</head>
<body>

	<div id="container"></div>

	<div id="flickr"></div>
	<div id="yahoo"></div>

	<script type="text/javascript" src="/globe/third-party/Three/ThreeWebGL.js"></script>
	<script type="text/javascript" src="/globe/third-party/Three/ThreeExtras.js"></script>
	<script type="text/javascript" src="/globe/third-party/Three/RequestAnimationFrame.js"></script>
	<script type="text/javascript" src="/globe/third-party/Three/Detector.js"></script>
	<script type="text/javascript" src="/globe/third-party/Tween.js"></script>
	<script type="text/javascript" src="/globe/globe.js"></script>
	<script type="text/javascript" src="http://nolancaudill.com:1361/socket.io/socket.io.js"></script>
	<script type="text/javascript">

	if (!Detector.webgl) {
		Detector.addGetWebGLMessage();
	}
	else {
		var container = document.getElementById('container'),
			globe       = new DAT.Globe(container),
			socket      = io.connect('http://nolancaudill.com:1361/'),
			points      = {},
			mode        = 5,
			UPPER_LIMIT = 15;
		
		globe.animate();
		
		socket.on('connect', function() {
			socket.emit('subscribe', { events: ['nolansflickrdemo'] });
		});
		
		socket.on('publish', function(data) {
			var raw = data.raw,
				lat = Math.round(raw['geo:lat']),
				lon = Math.round(raw['geo:long']);
			
			// Make sure we have the goods
			if (isNaN(lat) || isNaN(lon)) { return; }
			
			var k = 'l' + lat + 'l' + lon;
			
			if (points[k]) {
				points[k]++;
				
				if (points[k] > mode && mode < UPPER_LIMIT) {
					mode = points[k];
				}
			}
			else {
				points[k] = 1;
			}
			
			// console.log('new point', lat, lon, raw);
			// console.log(points[k], 'of them, mode:', mode);
		
			globe.addData([lat, lon, Math.min(points[k] / mode / 2, 1)], {
				format: 'magnitude'
			});

			globe.createPoints();
		});
	}

	</script>

</body>

</html>
