<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>WebGL Globe</title>
	<meta charset="utf-8">
	<style type="text/css">
		html { height: 100%; }
		body {
			margin: 0;
			padding: 0;
			background: #000000 url(/globe/loading.gif) center center no-repeat;
			color: #ffffff;
			font-family: sans-serif;
			font-size: 13px;
			line-height: 20px;
			height: 100%;
		}

		#title {
			position: absolute;
			top: 20px;
			width: 270px;
			left: 20px;
			background-color: rgba(0,0,0,0.2);
			border-radius: 3px;
			font: 20px Georgia;
			padding: 10px;
		}
	</style>
</head>
<body>

	<div id="container"></div>

	<div id="title">
		Worldwide Uploads
	</div>

	<script type="text/javascript" src="/globe/third-party/Three/ThreeWebGL.js"></script>
	<script type="text/javascript" src="/globe/third-party/Three/ThreeExtras.js"></script>
	<script type="text/javascript" src="/globe/third-party/Three/RequestAnimationFrame.js"></script>
	<script type="text/javascript" src="/globe/third-party/Three/Detector.js"></script>
	<script type="text/javascript" src="/globe/third-party/Tween.js"></script>
	<script type="text/javascript" src="/globe/globe.js"></script>
	<script type="text/javascript" src="http://nolancaudill.com:1361/socket.io/socket.io.js"></script>
	<script type="text/javascript">

	if (!Detector.webgl) {
		Detector.addGetWebGLMessage();
	}
	else {
		var container = document.getElementById('container'),
			globe     = new DAT.Globe(container),
			socket    = io.connect('http://nolancaudill.com:1361/'),
			points    = {},
			mode      = 10;
		
		globe.animate();
		
		socket.on('connect', function() {
			socket.emit('subscribe', { events: ['nolansflickrdemo'] });
		});
		
		socket.on('publish', function(data) {
			var raw = data.raw,
				lat = Math.round(raw['geo:lat']),
				lon = Math.round(raw['geo:long']);
			
			// Make sure we have the goods
			if (isNaN(lat) || isNaN(lon)) { return; }
			
			var k = 'l' + lat + 'l' + lon;
			
			if (points[k]) {
				points[k]++;
				
				if (points[k] > mode) {
					mode = points[k];
				}
			}
			else {
				points[k] = 1;
			}
			
			// console.log('new point', lat, lon, raw);
			// console.log(points[k], 'of them, mode:', mode);
		
			globe.addData([lat, lon, points[k] / mode / 2], {
				format: 'magnitude'
			});

			globe.createPoints();
		});
	}

	</script>

</body>

</html>
