<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Flobe</title>
	<meta charset="utf-8">
	<style type="text/css">
		html { height: 100%; }
		body {
			margin: 0;
			padding: 0;
			background: black url(loading.gif) no-repeat center center;
			color: white;
			font-family: sans-serif;
			font-size: 13px;
			line-height: 20px;
			height: 100%;
		}

		#flickr {
			position: absolute;
			top: 10px;
			left: 10px;
			background: transparent url('http://l.yimg.com/g/images/flickr-sprite.png.v3') no-repeat -1083px -9px;
			width: 75px;
			height: 22px;
		}
		
		#yahoo {
			position: absolute;
			top: 23px;
			left: 85px;
			width: 69px;
			height: 9px;
			background: url('http://l.yimg.com/g/images/lightbox/en-us/from-yahoo-white.png') no-repeat 0 0;
		}
	</style>
</head>
<body>

	<div id="container"></div>

	<div id="flickr"></div>
	<div id="yahoo"></div>

	<script type="text/javascript" src="third-party/Three/ThreeWebGL.js"></script>
	<script type="text/javascript" src="third-party/Three/ThreeExtras.js"></script>
	<script type="text/javascript" src="third-party/Three/RequestAnimationFrame.js"></script>
	<script type="text/javascript" src="third-party/Three/Detector.js"></script>
	<script type="text/javascript" src="third-party/Tween.js"></script>
	<script type="text/javascript" src="globe.js"></script>
	<script type="text/javascript" src="http://nolancaudill.com:1361/socket.io/socket.io.js"></script>
	<script type="text/javascript">

	if (!Detector.webgl) {
		Detector.addGetWebGLMessage();
	}
	else {
		function rand(min, max) {
			return Math.floor(Math.random() * (max - min)) + min;
		}
		
		var container = document.getElementById('container'),
			globe       = new DAT.Globe(container),
			socket      = io.connect('http://nolancaudill.com:1361/'),
			points      = {},
			total       = 0,
			UPPER_LIMIT = 17,
			FUDGE,
			PERCENT_CAP;
		
		globe.animate();
		
		// Hacky way to make the world spin
		// setInterval(function() {
		// 	target.x += 4;
		// 	globe.animate();
		// }, 10000)
		
		socket.on('connect', function() {
			socket.emit('subscribe', { events: ['nolansflickrdemo'] });
		});
		
		socket.on('publish', function(data) {
			var raw = data.raw,
			    lat = Math.round(raw['geo:lat']),
			    lon = Math.round(raw['geo:long']);
			
			// Make sure we have the goods
			if (isNaN(lat)
				|| isNaN(lon)
				|| (lat === 0 && lon === 0))
			{
				return;
			}
			
			var k = 'l' + lat + 'l' + lon;

			if (points[k]) { points[k]++;   }
			else           { points[k] = 1; }
			
			FUDGE       = rand(0.9, 1.1);
			PERCENT_CAP = rand(0.65, 0.75);
			
			strength = FUDGE * points[k] / UPPER_LIMIT;
			total++;

			// console.log('new point', lat, lon, raw);
			// console.log('count:', points[k], 'total:', total);
			// console.log('strength:', points[k] / UPPER_LIMIT, 'decision:', Math.min(points[k] / UPPER_LIMIT, PERCENT_CAP));

			globe.addData([lat, lon, Math.min(strength, PERCENT_CAP)], {
				format: 'magnitude'
			});

			globe.createPoints();
		});
	}

	</script>

</body>

</html>
